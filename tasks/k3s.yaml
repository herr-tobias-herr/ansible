---
- name: Download K3s installation script
  ansible.builtin.get_url:
    url: https://get.k3s.io
    dest: /tmp/k3s_install.sh
    mode: '0755'
    force: yes  # force redownload to ensure the file is present

- name: Verify K3s install script exists
  ansible.builtin.stat:
    path: /tmp/k3s_install.sh
  register: k3s_script

- name: Debug the script presence
  ansible.builtin.debug:
    msg: "K3s install script exists: {{ k3s_script.stat.exists }}"

- name: Install K3s (server)
  ansible.builtin.shell: |
    K3S_KUBECONFIG_MODE="644" sh /tmp/k3s_install.sh
  args:
    creates: /usr/local/bin/k3s
  when: 
    - k3s_script.stat.exists
    - "'master' in group_names"

- name: Install K3s agent and join the cluster
  ansible.builtin.shell: |
    K3S_URL="https://192.168.1.1:6443" K3S_TOKEN="{{ k3s_token }}" sh /tmp/k3s_install.sh agent
  args:
    creates: /usr/local/bin/k3s
  when:
    - k3s_script.stat.exists
    - "'servants' in group_names"

- name: Set Kubeconfig file permissions for current user
  ansible.builtin.file:
    path: /etc/rancher/k3s/k3s.yaml
    mode: '0644'
  when: "'master' in group_names"

- name: Change ownership of kubeconfig to current user
  ansible.builtin.file:
    path: /etc/rancher/k3s/k3s.yaml
    owner: "{{ ansible_facts['user_id'] }}"          # ← Changed: ansible_facts['user_id']
    group: "{{ ansible_facts['user_id'] }}"          # ← Changed
  when: ansible_facts['user_id'] != 'root'           # ← Changed

- name: Clean up K3s installation script (only on Ubuntu)
  ansible.builtin.file:
    path: /tmp/k3s_install.sh
    state: absent
  when: ansible_facts['distribution'] == 'Ubuntu'    # ← Changed

- name: Reboot system to finalize K3s setup
  ansible.builtin.reboot:
    msg: "Reboot initiated by Ansible after K3s installation"
    reboot_timeout: 300
